(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const k of a.addedNodes)k.tagName==="LINK"&&k.rel==="modulepreload"&&o(k)}).observe(document,{childList:!0,subtree:!0});function n(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(i){if(i.ep)return;i.ep=!0;const a=n(i);fetch(i.href,a)}})();const j=void 0,f=`https://${j}:3000`;console.log(f);const L=new URLSearchParams(window.location.hash.substring(1));let p=L.get("access_token");L.get("refresh_token");async function s(e,t,n){return await(await fetch(`https://api.spotify.com/${e}`,{headers:{Authorization:`Bearer ${p}`},method:t,body:JSON.stringify(n)})).json()}async function u(e,t,n){if(console.log(e),(await fetch(`https://api.spotify.com/${e}`,{headers:{Authorization:`Bearer ${p}`},method:t,body:n})).status===403)return!0}async function R(){let e=(await s("v1/me/tracks?limit=1&offset=0","GET")).total;for(let t=1;t*50<e+50;t++){let n=t*50,o=(await s(`v1/me/tracks?limit=50&offset=${n}`,"GET")).items;P(o),await y(1e3)}}async function b(){let e=(await s("v1/me/top/tracks?time_range=long_term&limit=50","GET")).items;h(e),w(e),await y(1e3);let t=(await s("v1/me/top/tracks?time_range=medium_term&limit=50","GET")).items;h(t),w(t),await y(1e3);let n=(await s("v1/me/top/tracks?time_range=short_term&limit=50","GET")).items;h(n),w(n),await y(1e3);let o=(await s("v1/me/player/recently-played?limit=50","GET")).items;P(o)}function w(e){e.forEach(t=>{m[t.id]=t.name})}function h(e){e.forEach(t=>{d[t.id]=t.name})}function P(e){e.forEach(t=>{d[t.track.id]=t.track.name})}function U(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}}function y(e){return new Promise(t=>setTimeout(t,e))}async function $(){let e=Object.keys(m);U(e);let t=e.slice(0,4),o=(await s(`v1/recommendations?limit=4&seed_tracks=${t.join(",")}`,"GET")).tracks.map(i=>({id:i.id,name:i.name,artist:i.artists[0].name,cover:i.album.images[0].url}));o=o.filter(i=>!(i.id in d)),o.forEach(i=>{c.push(i)})}async function B(e){const t=`${f}/file-exists/${e}`;return(await(await fetch(t)).json()).exists}async function T(e){const t=`${f}/read-data/${e}`,n=await fetch(t);if(n.ok){const o=await n.json();return console.log("File data:",o),o}else return console.error("File not found"),null}async function E(e,t){const n=`${f}/export/${t}`;(await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok?console.log("Data sent successfully"):console.error("Failed to send data")}async function A(){await B("blacklist")?(d=await T("blacklist"),console.log("Data from file:",d)):(console.log("Blacklist does not exist, going to load data"),console.log("getting top songs"),await b(),console.log("getting library"),await R(),E(d,"blacklist")),await B("seedlist")?(m=await T("seedlist"),console.log("Data from file:",m)):(console.log("seedList does not exist, going to load data"),console.log("getting top songs"),await b(),E(m,"seedlist"))}function C(e){console.log("showing");let t=document.getElementById("current-song");t.textContent=`${e.name}`;let n=document.getElementById("artist-details");n.textContent=`${e.artist}`;let o=document.getElementById("album-cover-image");o.src=`${e.cover}`}async function v(){l++,document.getElementById("play-pause").style.backgroundImage="url('media/pause.png')",await I(c[l]),l>c.length-2&&await $()}async function I(e){C(e),console.log("playing",e);let t=e.id;await u(`v1/me/player/play?device_id=${r}`,"PUT",JSON.stringify({uris:[`spotify:track:${t}`]})),await W(),d[t]=e.name,E(d,"blacklist")}async function F(){l--,document.getElementById("play-pause").style.backgroundImage="url('media/pause.png')",await I(c[l])}async function S(){console.log("pause"),await u(`v1/me/player/pause?device_id=${r}`,"PUT")}async function _(){console.log("resume"),await u(`v1/me/player/play?device_id=${r}`,"PUT")&&(console.log("403, skipping"),await v())}async function x(){let e=c[l].id;await u(`v1/me/tracks?ids=${e}`,"PUT")}async function M(){let e=c[l].id;console.log("unlike",c[l].name),await u(`v1/me/tracks?ids=${e}`,"DELETE")}async function D(){g=!g,g?(document.getElementById("play-pause").style.backgroundImage="url('media/pause.png')",await _()):(document.getElementById("play-pause").style.backgroundImage="url('media/play.png')",await S())}async function N(){!(await s(`v1/me/player?device_id=${r}`,"GET")).is_playing&&g&&(console.log("song ended"),await v())}window.onSpotifyWebPlaybackSDKReady=()=>{const e=new Spotify.Player({name:"Better Spotify Recs",getOAuthToken:t=>{t(p)},volume:1});e.addListener("ready",({device_id:t})=>{console.log("Ready with Device ID",t),r=t,O()}),e.addListener("not_ready",({device_id:t})=>{console.log("Device ID has gone offline",t)}),e.addListener("initialization_error",({message:t})=>{console.error(t)}),e.addListener("authentication_error",({message:t})=>{console.error(t)}),e.addListener("account_error",({message:t})=>{console.error(t)}),e.connect()};let O;const q=new Promise(e=>{O=e});async function W(){let e=c[l].id;(await s(`v1/me/tracks/contains?ids=${e}`,"GET"))[0]?(document.getElementById("like").style.backgroundImage="url('media/liked.png')",document.getElementById("like").dataset.liked="true"):(document.getElementById("like").style.backgroundImage="url('media/unliked.png')",document.getElementById("like").dataset.liked="false")}document.getElementById("next").onclick=async function(){await v()};document.getElementById("like").onclick=async function(){this.dataset.liked==="true"?(await M(),this.style.backgroundImage="url('media/unliked.png')",this.dataset.liked="false"):(await x(),this.style.backgroundImage="url('media/liked.png')",this.dataset.liked="true")};document.getElementById("album-cover-image").addEventListener("dblclick",()=>{x(),document.getElementById("like").style.backgroundImage="url('media/liked.png')",(void 0).dataset.liked="true"});document.getElementById("play-pause").onclick=async function(){await D()};document.getElementById("previous").onclick=async function(){await F()};document.getElementById("sign-out").onclick=J;window.addEventListener("keydown",function(e){e.key===" "&&D()});async function G(e){const t=document.getElementById("devices-list");t.innerHTML="",e.forEach(n=>{const o=document.createElement("button");o.innerText=n.name,n.is_active&&(o.innerHTML+=" âœ”",o.style.fontWeight="bold"),o.onclick=async()=>{await S(),r=n.id,await _(),await u(`v1/me/player/repeat?state=off&device_id=${r}`,"PUT");const i=(await s("v1/me/player/devices","GET")).devices;G(i)},t.appendChild(o)})}document.getElementById("settings-button").addEventListener("click",async e=>{e.stopPropagation();const t=document.getElementById("settings-dropdown");t.style.display="block";const n=(await s("v1/me/player/devices","GET")).devices;G(n)});document.addEventListener("click",e=>{const t=document.getElementById("settings-dropdown"),n=document.getElementById("settings-button");!t.contains(e.target)&&e.target!==n&&(t.style.display="none")});function z(){const e=document.createElement("script");e.src="https://sdk.scdn.co/spotify-player.js",e.async=!0,document.body.appendChild(e)}function J(){document.cookie="signedIn=false; path=/",window.location.href="logout"}let d={},m={},c=[],g=!0,l=0,r;async function H(){document.getElementById("login-button").style.display="none",z(),document.getElementById("container").style.display="flex",await q,await A(),await $(),document.getElementById("loading-text").style.display="none",document.getElementById("settings").style.display="block",document.querySelector(".player-container").classList.add("ready"),document.getElementById("loaded-content").style.display="block",document.querySelector(".album-cover").classList.add("fade-in-album"),document.querySelector(".song-details").classList.add("fade-in-album"),document.querySelector(".controls").classList.add("fade-in-controls"),await I(c[l]),await u(`v1/me/player/repeat?state=off&device_id=${r}`,"PUT"),setInterval(N,5e3)}function K(e){let t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]+)"));return t?t[2]:null}document.addEventListener("DOMContentLoaded",function(){p?H():K("signedIn")==="true"?window.location.href="/login?show_dialog=false":document.getElementById("login-button").style.display="block"});
